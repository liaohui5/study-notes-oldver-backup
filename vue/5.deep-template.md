## Vue æ˜¯å¦‚ä½•è§£ææ¨¡æ¿çš„?

1. å°† html å­—ç¬¦ä¸²è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘(AST)
2. æ ¹æ® AST ç”Ÿæˆ render å‡½æ•°éœ€è¦çš„å­—ç¬¦ä¸², ç„¶åç”Ÿæˆ render å‡½æ•°
3. render å‡½æ•° å°† AST å¤„ç†ä¸ºè™šæ‹ŸèŠ‚ç‚¹å¯¹è±¡(vnode) -> åœ¨ç”Ÿæˆçš„æ—¶å€™, å¤„ç†æŒ‡ä»¤, å·®å€¼è¡¨è¾¾å¼
4. å°† vnode æ¸²æŸ“æˆçœŸå®çš„ DOM ç„¶åæŒ‚è½½æ–‡æ¡£ä¸­

## å¦‚ä½•å°† html å­—ç¬¦ä¸²è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘

1. åˆ©ç”¨ stack ç»“æ„ä¿æŒæ ‘å½¢å…³ç³»
2. ä¸æ–­çš„å»åŒ¹é…æ ‡ç­¾å¼€å§‹,å±æ€§,æ ‡ç­¾ç»“æŸ,é—­åˆæ ‡ç­¾,ç„¶åæˆªå–
3. ä¸æ–­çš„å»åŒ¹é…æ–‡æœ¬ç„¶åæˆªå–
4. æˆªå–åˆ°æœ€å, å¤„ç†ä¸ºå¯¹åº”ç»“æ„çš„æŠ½è±¡è¯­æ³•æ ‘

### ç¯å¢ƒè¯´æ˜

ä½¿ç”¨ vite å¯åŠ¨ä¸€ä¸ªæœåŠ¡, ç„¶åè®¿é—®

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>htmlPaser</title>
  </head>
  <body>
    <div id="container"></div>

    <!-- template parser -->
    <script type="module" src="./index.js"></script>
  </body>
</html>
```

### å¾…å¤„ç†çš„æ¨¡æ¿å­—ç¬¦ä¸²

```js
let html = /* html */ `<div id="app" style="color: red; font-size: 20px">
  ä½ å¥½ {{name}}, æˆ‘çš„å¹´é¾„æ˜¯ {{age}}, ä½ ä»Šå¹´å¤šå°‘å²?
  <p id="mid" style='color: #0f0; font-size: 20px;'>
    <span class=text>è¿™æ˜¯spançš„å†…å®¹</span>
  </p>
  <selection id="inner" style='color: #0f0;'>
    <img src="https://game.gtimg.cn/images/lol/act/img/skin/big1000.jpg" style="max-width: 100px;"/>
  </selection>
</div>`;
```

### å¤„ç†ç¨‹åº

```js
const ast = html2ast(html);
console.log(ast);

// å°† html åˆ†æä¸ºä¸€ä¸ª dom æ ‘
function html2ast(html) {
  // å±æ€§å=å±æ€§å€¼: name="value" name='value' name=value
  const attribute =
    /^\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/;
  const ncname = `[a-zA-Z_][\\-\\.0-9_a-zA-Z]*`;
  const qnameCapture = `((?:${ncname}\\:)?${ncname})`;
  const startTagOpen = new RegExp(`^<${qnameCapture}`);
  const startTagClose = /^\s*(\/?)>/;
  const endTag = new RegExp(`^<\\/${qnameCapture}[^>]*>`);

  let text,
    root,
    stack = [],
    currentParent;

  while (html) {
    const textEnd = html.indexOf("<");
    if (textEnd === 0) {
      const startTagMatch = parseStartTag();
      if (startTagMatch) {
        start(startTagMatch.tag, startTagMatch.attrs);
        continue;
      }

      // å¦‚æœæ˜¯ç»“æŸæ ‡ç­¾ </div> /> è¿™ç§çš„
      const endTagMatch = html.match(endTag);
      if (endTagMatch) {
        cut(endTagMatch[0].length);
        end(endTagMatch);
        continue;
      }
    }

    // å¦‚æœ < å¤§äº0è¯´æ˜æœ‰æ–‡æœ¬å†…å®¹, å¤„ç†æ–‡æœ¬å†…å®¹
    if (textEnd > 0) {
      text = html.substring(0, textEnd);
    }

    // å¦‚æœæœ‰ text å°±å¤„ç†æ–‡æœ¬å†…å®¹
    if (text) {
      cut(textEnd);
      chars(text);
    }
  }
  return root;

  // è£å‰ªhtml
  function cut(startIndex) {
    html = html.substring(startIndex);
  }

  // å¤„ç†å¼€å§‹æ ‡ç­¾
  function parseStartTag() {
    // console.info("parseStartTag: \n", html);
    const startTag = html.match(startTagOpen);
    if (!startTag) {
      return;
    }
    const [start, tag] = startTag;
    const matched = {
      tag,
      attrs: [], // attrs: [ {name: 'id', value: 'app'} ]
    };
    cut(start.length);

    // æ˜¯å¦åŒ¹é…åˆ°äº† > æˆ–è€… />, å°±ç»“æŸå¾ªç¯, å¦‚æœæ²¡æœ‰å°±è§£æå±æ€§
    let end, attr;
    while (
      !(end = html.match(startTagClose)) &&
      (attr = html.match(attribute))
    ) {
      // attr[1]: åŒ¹é…åˆ°çš„å±æ€§å
      // 3: class="box", 4: class='box', 5: class=box
      matched.attrs.push({
        name: attr[1],
        value: attr[3] || attr[4] || attr[5],
      });
      cut(attr[0].length);
    }

    if (end) {
      cut(end[0].length);
      return matched;
    }
  }

  // åˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ª, å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªä¸€å®šæ˜¯æ ¹å…ƒç´ 
  // å°†å½“å‰å…ƒç´ æ·»åŠ åˆ° stack ä¸­, [div, span]
  function start(tag, attrs) {
    const element = createASTElement(tag, attrs);
    if (!root) {
      root = element;
    }
    currentParent = element;
    stack.push(element);
  }

  // å¦‚æœ stack ç°åœ¨æ˜¯: [div, span], pop æ“ä½œå, å˜æˆ
  // [div], é‚£ä¹ˆ stack[stack.length - 1] è·å–åˆ°çš„å°±æ˜¯ div
  // å¦‚æœ stack æ˜¯: [div], pop æ“ä½œå, å˜æˆ: [],
  // é‚£ä¹ˆ stack[stack.length - 1] è·å–åˆ°çš„æ˜¯undefined,
  // é‚£ä¹ˆè¯´æ˜æ˜¯æ ¹å…ƒç´ , å¦‚æœä¸æ˜¯æ ¹å…ƒç´ , è‚¯å®šæœ‰ currentParent
  // é‚£ä¹ˆå°±ç›´æ¥æŠŠ element çš„ parent å…ƒç´ å¼•ç”¨, èµ‹å€¼ç»™ element.parent
  // å¾ªç¯å¼•ç”¨
  function end() {
    const element = stack.pop();
    const parent = stack[stack.length - 1];
    if (parent) {
      element.parent = parent;
      parent.children.push(element);
    }
  }

  // å¤„ç†æ–‡æœ¬å†…å®¹
  function chars(text) {
    text = text.trim();
    if (text) {
      currentParent.children.push({
        type: Node.TEXT_NODE,
        text,
      });
    }
  }

  // åˆ›å»ºä¸€ä¸ª AST å…ƒç´ 
  function createASTElement(tag, attrs) {
    return {
      tag,
      attrs,
      type: Node.ELEMENT_NODE,
      children: [],
      parent: null,
    };
  }
}
```

### å¤„ç†åçš„ AST å¯¹è±¡

!> å¤„ç†åçš„ç»“æœ: ç”±äº parent ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨, æ— æ³• JSON.stringify æŸ¥çœ‹æ•ˆæœ,æ‰€ä»¥å»é™¤äº† parent å±æ€§

```json
{
  "tag": "div",
  "attrs": [
    {
      "name": "id",
      "value": "app"
    },
    {
      "name": "style",
      "value": "color: red; font-size: 20px"
    }
  ],
  "type": 1,
  "children": [
    {
      "type": 3,
      "text": "ä½ å¥½ {{name}}, æˆ‘çš„å¹´é¾„æ˜¯ {{age}}, ä½ ä»Šå¹´å¤šå°‘å²?"
    },
    {
      "tag": "p",
      "attrs": [
        {
          "name": "id",
          "value": "mid"
        },
        {
          "name": "style",
          "value": "color: #0f0; font-size: 20px;"
        }
      ],
      "type": 1,
      "children": [
        {
          "tag": "span",
          "attrs": [
            {
              "name": "class",
              "value": "text"
            }
          ],
          "type": 1,
          "children": [
            {
              "type": 3,
              "text": "è¿™æ˜¯spançš„å†…å®¹"
            }
          ],
          "parent": null
        }
      ],
      "parent": null
    },
    {
      "tag": "selection",
      "attrs": [
        {
          "name": "id",
          "value": "inner"
        },
        {
          "name": "style",
          "value": "color: #0f0;"
        }
      ],
      "type": 1,
      "children": [
        {
          "tag": "img",
          "attrs": [
            {
              "name": "src",
              "value": "https://game.gtimg.cn/images/lol/act/img/skin/big1000.jpg"
            },
            {
              "name": "style",
              "value": "max-width: 100px;"
            }
          ],
          "type": 1,
          "children": [],
          "parent": null
        }
      ],
      "parent": null
    }
  ],
  "parent": null
}
```

## æ ¹æ® AST ç”Ÿæˆ render å‡½æ•°éœ€è¦çš„ code

### ç”Ÿæˆæ¸²æŸ“å‡½æ•° && ç”Ÿæˆæ¸²æŸ“å‡½æ•°éœ€è¦çš„å­—ç¬¦ä¸²

```js
// ç”Ÿæˆ render å‡½æ•°
function getRender(code) {
  return new Function(`with(this) { return ${code}}`);
}

// æ ¹æ® ast è¯­æ³•æ ‘å˜æˆä¸€ä¸ª render å‡½æ•°éœ€è¦çš„å­—ç¬¦ä¸²
function generate(element) {
  const attrs = getAttrs(element.attrs);
  let children = element.children;
  if (children.length > 0) {
    // æœ‰å­å…ƒç´ æ‰å¤„ç†å­å…ƒç´ 
    children = children.map((node) => getChildren(node)).join(",");
  }
  return `_c("${element.tag}", ${attrs}, ${children})`;

  // å¤„ç†å…ƒç´ çš„å±æ€§
  function getAttrs(attrs) {
    const attrMap = {};
    attrs.forEach((attr) => {
      if (attr.name === "style") {
        attrMap["style"] = handleStyle(attr.value);
      } else {
        attrMap[attr.name] = attr.value;
      }
    });
    return JSON.stringify(attrMap);

    // å¤„ç† style
    function handleStyle(styles) {
      // style="color : #f00; font-size: 20px ; "
      const styleMap = {};
      styles.split(";").forEach((item) => {
        const [key, value] = item.split(":");
        if (key && value) {
          styleMap[key] = value.trim();
        }
      });
      return styleMap;
    }
  }

  // å¤„ç†å…ƒç´ çš„å­å…ƒç´ 
  function getChildren(node) {
    if (node.type === Node.ELEMENT_NODE) {
      return generate(node);
    } else if (node.type === Node.TEXT_NODE) {
      return handleTextNode(node.text);
    }

    function handleTextNode(text) {
      const mustcheTag = /\{\{(.+?)\}\}/g;
      if (!text.match(mustcheTag)) {
        return `_v("${text}")`;
      }
      let tokens = [],
        startIndex = 0,
        match;

      while ((match = mustcheTag.exec(text))) {
        // ä½ å¥½ {{name}}, æˆ‘çš„å¹´é¾„æ˜¯ {{age}}, ä½ ä»Šå¹´å¤šå°‘å²?
        tokens.push(JSON.stringify(text.slice(startIndex, match.index)));
        tokens.push(`_s(${match[1]})`);
        startIndex = mustcheTag.lastIndex;
      }
      // å¦‚æœæ˜¯ä»¥æ–‡å­—ç»“å°¾, æœ€åä¸€æ®µæ˜¯æ— æ³•åŒ¹é…åˆ°çš„: ", ä½ ä»Šå¹´å¤šå°‘å²?"
      // è¿™ä¸€æ®µå°±ä¼šä¸¢å¤±, æ‰€ä»¥è¦æ‰‹åŠ¨æŠŠæœ€åä¸€æ®µè£å‰ªå‡ºæ¥
      tokens.push(JSON.stringify(text.slice(startIndex)));
      tokens = tokens.join("+");
      return `_v(${tokens})`;
    }
  }
}
```

### å¤„ç†åçš„å­—ç¬¦ä¸²

```js
(function anonymous() {
  with (this) {
    return _c(
      "div",
      { id: "app", style: { color: "red", " font-size": "20px" } },
      _v("ä½ å¥½ " + _s(name) + ", æˆ‘çš„å¹´é¾„æ˜¯ " + _s(age) + ", ä½ ä»Šå¹´å¤šå°‘å²?"),
      _c(
        "p",
        { id: "mid", style: { color: "#0f0", " font-size": "20px" } },
        _c("span", { class: "text" }, _v("è¿™æ˜¯spançš„å†…å®¹"))
      ),
      _c(
        "selection",
        { id: "inner", style: { color: "#0f0" } },
        _c("img", {
          src: "https://game.gtimg.cn/images/lol/act/img/skin/big1000.jpg",
          style: { "max-width": "100px" },
        })
      )
    );
  }
});
```

## æ ¹æ® render å‡½æ•°ç”Ÿæˆ vnode

### å®ç°å®ä¾‹åŸå‹ä¸Šçš„ \_c && \_v && \_s, è®© render å‡½æ•°èƒ½å¤Ÿé¡ºåˆ©è°ƒç”¨

1. \_c: åˆ›å»ºå…ƒç´ èŠ‚ç‚¹
2. \_v: å¤„ç†æ–‡æœ¬èŠ‚ç‚¹
3. \_s: å¤„ç†ç±»ä¼¼ `{{name}}` çš„ mustche è¯­æ³•

```js
// æ¨¡æ‹Ÿ Vue å®ä¾‹å¯¹è±¡ vm
const vm = {
  name: "tom",
  age: 22,
  el: document.querySelector("#container"),
};
Object.setPrototypeOf(vm, {
  // ç»™ vm åŸå‹å¯¹è±¡æ·»åŠ  _c,_s,_v è®© render å‡½æ•°å¯ä»¥è°ƒç”¨è¿™äº›æ–¹æ³•
  _c() {
    return createElement(...arguments);
  },
  _s(value) {
    if (!value) return;
    return typeof value === "object" ? JSON.stringify(value) : value;
  },
  _v(text) {
    return createTextVNode(text);
  },
});

const ast = html2ast(html);
const renderCode = generate(ast);
const render = getRender(renderCode);
const vnodes = render.call(vm);
console.log("ğŸ‹ vnodes: ", vnodes);
```

### åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ç›¸å…³å‡½æ•°

```js
// åˆ›å»ºè™šæ‹ŸdomèŠ‚ç‚¹ vnode
function vnode(tag, props, children, text) {
  return { tag, props, children, text };
}

// åˆ›å»ºå…ƒç´ ç±»å‹è™šæ‹ŸèŠ‚ç‚¹
function createElement(tag, attrs = {}, ...children) {
  return vnode(tag, attrs, children);
}

// åˆ›å»ºæ–‡æœ¬ç±»å‹è™šæ‹ŸèŠ‚ç‚¹
function createTextVNode(text) {
  return vnode(undefined, undefined, undefined, text);
}
```

### å¤„ç†åçš„ vnode

```json
{
  "tag": "div",
  "props": {
    "id": "app",
    "style": {
      "color": "red",
      " font-size": "20px"
    }
  },
  "children": [
    {
      "text": "ä½ å¥½ tom, æˆ‘çš„å¹´é¾„æ˜¯ 22, ä½ ä»Šå¹´å¤šå°‘å²?"
    },
    {
      "tag": "p",
      "props": {
        "id": "mid",
        "style": {
          "color": "#0f0",
          " font-size": "20px"
        }
      },
      "children": [
        {
          "tag": "span",
          "props": {
            "class": "text"
          },
          "children": [
            {
              "text": "è¿™æ˜¯spançš„å†…å®¹"
            }
          ]
        }
      ]
    },
    {
      "tag": "selection",
      "props": {
        "id": "inner",
        "style": {
          "color": "#0f0"
        }
      },
      "children": [
        {
          "tag": "img",
          "props": {
            "src": "https://game.gtimg.cn/images/lol/act/img/skin/big1000.jpg",
            "style": {
              "max-width": "100px"
            }
          },
          "children": []
        }
      ]
    }
  ]
}
```

## æ ¹æ® vnode ç”ŸæˆçœŸå® dom,æ¸²æŸ“åˆ°é¡µé¢ä¸Š

> è¿™ä¸ªå°±ä¸æ˜¯å¾ˆé‡è¦äº†, é‡è¦çš„æ˜¯å¦‚ä½•é«˜æ•ˆçš„ç”Ÿæˆ vnode(diff ç®—æ³•), å› ä¸º vnode éƒ½ç”Ÿæˆäº†, æ ¹æ®ç»“æ„ç”ŸæˆçœŸå®çš„ dom ç„¶åæ¸²æŸ“åˆ°é¡µé¢ä¸Š, æ— éå°±æ˜¯æ“ä½œ dom

```js
// æ›´å…· vnode, ç”ŸæˆçœŸå®çš„DOMèŠ‚ç‚¹, æ”¾åˆ° el ä¸­å»
function patch(vnode) {
  const elements = createElement(vnode);
  this.el.append(elements); // æ³¨æ„å°† this ä¿®æ”¹ä¸º vm å¯¹è±¡

  // ç”ŸæˆçœŸå®çš„DOMèŠ‚ç‚¹
  function createElement(vnode) {
    // åˆ›å»ºå¯¹åº”ç»“æ„çš„ elementNode å’Œ textNode
    const { text, children, tag, props } = vnode;
    if (typeof tag === "string") {
      const el = (vnode.el = document.createElement(tag));
      updateProps(el, props);
      children.map((node) => el.append(createElement(node)));
    } else {
      vnode.el = document.createTextNode(text);
    }
    return vnode.el;
  }

  // åˆ›å»ºçœŸå®çš„domæ—¶å¤„ç†domå±æ€§
  function updateProps(el, props = {}) {
    for (const key in props) {
      if (Object.hasOwnProperty.call(props, key)) {
        const value = props[key];
        if (key === "style") {
          for (const sk in value) {
            el.style[sk.trim()] = value[sk];
          }
        } else if (key === "class") {
          value && (el.className = value);
        } else {
          el.setAttribute(key, value);
        }
      }
    }
  }
}
```

> å®Œæ•´çš„æµç¨‹

```js
// 0. æ¨¡æ‹Ÿ Vue å®ä¾‹å¯¹è±¡ vm
const vm = {
  name: "tom",
  age: 22,
  el: document.querySelector("#container"),
};
Object.setPrototypeOf(vm, {
  // ç»™åŸå‹ä¸Šæ·»åŠ  _c, _s, _v æ–¹æ³•
  _c() {
    return createElement(...arguments);
  },
  _s(value) {
    if (!value) return;
    return typeof value === "object" ? JSON.stringify(value) : value;
  },
  _v(text) {
    return createTextVNode(text);
  },
});

// 1. å°† html å­—ç¬¦ä¸²å¤„ç†ä¸º ast
const ast = html2ast(html);

// 2. æ ¹æ® ast ç”Ÿæˆ renderCode -> ç”Ÿæˆ render å‡½æ•°
const renderCode = generate(ast);
const render = getRender(renderCode);

// 3. render å‡½æ•°ç”Ÿæˆ vnodes
const vnodes = render.call(vm);

// 4. ç”ŸæˆçœŸå®çš„ DOM å¯¹è±¡ç„¶åappendåˆ° vm.el ä¸­
patch.call(vm, vnodes);
```
