## ç¯å¢ƒå‡†å¤‡

1. ä¸‹è½½ && å®‰è£… && å¯åŠ¨

```sh
git clone https://github.com/liaohui5/vue-diff-demo
cd vue-diff-demo
npm install
npm run dev

# æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:9527
```

2. ç›®å½•ç»“æ„

```sh
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ index.html
â”œâ”€â”€ js
â”‚Â Â  â”œâ”€â”€ diff.js           # diff æ¯”å¯¹ç®—æ³•ä¸»è¦åŠŸèƒ½å®ç°
â”‚Â Â  â”œâ”€â”€ index.js          # å¯¼å…¥å¹¶ä½¿ç”¨ diff/patch/vnode æŸ¥çœ‹æ•ˆæœ
â”‚Â Â  â”œâ”€â”€ patch.js          # ç»™çœŸå®domæ‰“è¡¥ä¸(ç®—æ³•æ¯”å¯¹åçš„ç»“æœ)
â”‚Â Â  â””â”€â”€ vnode.js          # ç±»ä¼¼ vue render çš„ h å‡½æ•°, åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹, å°†è™šæ‹ŸèŠ‚ç‚¹è½¬çœŸå®èŠ‚ç‚¹ç­‰åŠŸèƒ½
â”œâ”€â”€ package-lock.json
â””â”€â”€ package.json
```

## virtual DOM & real DOM
```
vDOM         : virtual DOM          - è™šæ‹ŸDOM(æè¿°çœŸå®DOMçš„ä¸€ä¸ªå¯¹è±¡)
vNode        : virtual Node         - è™šæ‹ŸèŠ‚ç‚¹(æè¿°çœŸå®èŠ‚ç‚¹çš„ä¸€ä¸ªå¯¹è±¡)
vNodeUid     : virtual Node index   - è™šæ‹ŸèŠ‚ç‚¹éå†æ—¶æ ‡è®° VNode çš„æ ‡è®°
rDOM         : real DOM             - çœŸå®çš„ HTMLElement å…ƒç´ 
rNode        : real Node            - çœŸå®çš„ HTMLElement èŠ‚ç‚¹
rNodeUid     : real Node index      - éå†çœŸå®çš„ HTMLElementèŠ‚ç‚¹ çš„æ ‡è®°
patchPackMap : virtual Node patch   - è™šæ‹ŸèŠ‚ç‚¹è¡¥ä¸Map
```

## æºç å®ç°

[https://github.com/liaohui5/vue-diff-demo](https://github.com/liaohui5/vue-diff-demo)


> æµ‹è¯•æ­¥éª¤
1. createVNode(h) å‡½æ•°ç±»ä¼¼ Vue çš„ h å‡½æ•°, ä¼ å…¥3ä¸ªå‚æ•°(æ ‡ç­¾å, å±æ€§é›†åˆ, å­èŠ‚ç‚¹)
2. createVNode(h) å‡½æ•°æ‰§è¡Œåè¿”å›ä¸€ä¸ª VirtualDOM
3. createRNode å‡½æ•°å¯ä»¥æŠŠ VirtualDOM è½¬åŒ–ä¸ºçœŸå®çš„ DOM å…ƒç´ 
4. mount å‡½æ•°å¯ä»¥æŠŠ åˆ›å»ºå‡ºæ¥çš„ DOM å…ƒç´ æŒ‚è½½é¡µé¢æŒ‡å®šçš„å…ƒç´ ä¸­

> æ¨¡æ‹Ÿå†…å®¹æ›´æ–°å: æ¯”è¾ƒæ–°è€VirtualDOMå·®å¼‚, ç„¶åç»™rNodeæ‰“ä¸Šè¡¥ä¸

1. diff: æ¯”è¾ƒæ–°è€VirtualDOMå·®å¼‚è·å¾— patches
2. patch: æ ¹æ®è·å¾—çš„ patches å»æ›´æ–° realDOM, æ›´æ–°UI

![diff-preview](https://raw.githubusercontent.com/liaohui5/images/main/images/202207181657589.png)

```html
<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>Vue Diff ç®—æ³•ç®€å•å®ç°</title>
  </head>
  <body>
    <div id="app"></div>
    <!-- javascript -->
    <script type="module" src="./js/index.js"></script>
  </body>
</html>

```

```js
// js/index.js
import { h, render, mount } from "./vnode";
import { diff } from "./diff";
import { patch } from "./patch";

// ä¿®æ”¹å‰çš„ virtualDOM
const oldVDom = h(
  "ul",
  {
    class: "list",
    style: "width: 300px; height: 300px; border: 1px solid #f00; color: #555;",
  },
  [
    h("li", { "data-index": 0, class: "item " }, [
      h("p", { class: "text" }, ["ç¬¬ä¸€ä¸ªåˆ—è¡¨é¡¹"]),
    ]),
    h("li", { "data-index": 1, class: "item" }, [
      h("p", { class: "text" }, [
        h("span", { class: "title" }, ["ç¬¬äºŒä¸ªåˆ—è¡¨é¡¹"]),
      ]),
    ]),
    h("li", { "data-index": 2, class: "item" }, ["ç¬¬ä¸‰ä¸ªåˆ—è¡¨é¡¹"]),
  ]
);

// æ¨¡æ‹Ÿä¿®æ”¹å†…å®¹åçš„ virtualDOM
const newVDom = h(
  "ul",
  {
    class: "list-wrapper",
    style: "width: 300px; height: 300px; border: 1px solid #555; color:#f00;",
  },
  [
    h("li", { "data-index": 0, class: "item active" }, [
      h("p", { class: "text" }, ["ç¬¬ä¸€ä¸ªåˆ—è¡¨é¡¹"]),
    ]),
    h("li", { "data-index": 1, class: "item" }, [
      h("p", { class: "text" }, ["è¿™æ˜¯ç¬¬äºŒä¸ªli, å†…å®¹è¢«æ›¿æ¢äº†"]),
    ]),
    h("li", { "data-index": 2, class: "item" }, [
      "è¿™æ˜¯ç¬¬3ä¸ªè¢«ä¿®æ”¹åçš„åˆ—è¡¨é¡¹å†…å®¹",
    ]),
  ]
);

// æ ¹æ®è€èŠ‚ç‚¹æ¸²æŸ“å‡ºçœŸå®çš„DOM
const realDOM = render(oldVDom);

// å°†çœŸå®domæŒ‚è½½åˆ°é¡µé¢å…ƒç´ ä¸­
mount(realDOM, document.getElementById("app"));

// newVDomæ¨¡æ‹Ÿæ•°æ®æ›´æ–°çš„è¿‡ç¨‹ -> å¯¹æ¯”æ–°è€VDom -> è·å¾—è¡¥ä¸åŒ…
const patchMap = diff(oldVDom, newVDom);
console.log('ğŸ¥§[patchMap]:', patchMap);

// ç»™çœŸå®èŠ‚ç‚¹æ‰“è¡¥ä¸
patch(realDOM, patchMap);
```

```js
// js/vnode.js
"use strict";

/**
 * è™šæ‹ŸèŠ‚ç‚¹
 */
export class VNode {
  constructor(type, props, children = []) {
    this.type     = type;
    this.props    = props;
    this.children = children;
  }
}

/**
 * å¤„ç†htmlæ ‡ç­¾å…ƒç´ çš„å±æ€§ id="xxx" style="xxx" class="xxx"
 * @param {HTMLElement} element çœŸå®DOMå…ƒç´ 
 * @param {Object} attr æ ‡ç­¾ä¸Šçš„å±æ€§
 * @param {String} val æ ‡ç­¾å±æ€§çš„å€¼
 */
export function setAttrs(element, attr, val) {
  switch (attr) {
    case "value":
      if (["INPUT", "TEXTAREA"].includes(element.tagName)) {
        element.value = val;
      } else {
        element.setAttribute(attr, val);
      }
      break;
    case "style":
      element.style.cssText = val;
      break;
    default:
      element.setAttribute(attr, val);
      break;
  }
}

/**
 * æŠŠè™šæ‹Ÿdomå˜æˆçœŸå®çš„domå…ƒç´ 
 * @param {VNode} vDom      è™šæ‹ŸDOM
 * @return {HTMLElement} el çœŸå®çš„DOMå…ƒç´ 
 */
export const render = createRNode;
export function createRNode(vDom) {
  const { type, props, children } = vDom;
  const el = document.createElement(type);

  // å¤„ç†å±æ€§
  Object.keys(props).forEach((key) => {
    setAttrs(el, key, props[key]);
  });

  // å¤„ç†å­èŠ‚ç‚¹(å…ƒç´ èŠ‚ç‚¹/æ–‡æœ¬èŠ‚ç‚¹)
  if (!Array.isArray(children)) {
    return el;
  }
  for (const child of children) {
    let childElement;
    if (child instanceof VNode) {
      childElement = createRNode(child);
    } else {
      childElement = document.createTextNode(child);
    }
    el.append(childElement);
  }

  return el;
}

/**
 * åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹
 * @param {String} type     æ ‡ç­¾å
 * @param {Object} props    å±æ€§é›†åˆ
 * @param {Array}  children å­èŠ‚ç‚¹
 */
export const h = createVNode;
export function createVNode(type, props, children) {
  return new VNode(type, props, children);
}

/**
 * å°†çœŸå®èŠ‚ç‚¹æŒ‚è½½åˆ°é¡µé¢ä¸­
 */
export function mount(el, container) {
  container.append(el);
}
```

```js
// js/diff.js
"use strict";
/*
const patchPackMap = {
  0: [
    {
      type: PatchPack.ATTR, // ä»£è¡¨ä¸€ä¸ªæ›´æ–°å±æ€§çš„è¡¥ä¸åŒ…
      value: { style: 'xxx', class: 'xxx', id: 'xxx' }
    }
  ],
  1: [
    {
      type: PatchPack.TEXT, // ä»£è¡¨ä¸€ä¸ªæ ‡ç­¾å†…éƒ¨æ–‡æœ¬çš„è¡¥ä¸åŒ…
      value: 'è¿™æ˜¯æ›´æ–°åè¦æ˜¾ç¤ºçš„æ–‡æœ¬'
    }
  ],
  2: [
    {
      type: PatchPack.REPLACE, // ä»£è¡¨ä¸€ä¸ªæ›¿æ¢èŠ‚ç‚¹çš„è¡¥ä¸åŒ…
      value: rNode
    }
  ],
  2: [
    {
      type: PatchPack.REMOVE, // ä»£è¡¨ä¸€ä¸ªç§»é™¤èŠ‚ç‚¹çš„è¡¥ä¸åŒ…
      value: index
    }
  ],
};
*/

import { PatchPack } from "./patch";
const { ATTR, TEXT, REPLACE, REMOVE } = PatchPack;

// æ–°è€èŠ‚ç‚¹å¯¹æ¯”åçš„å·®å¼‚è¡¥ä¸åŒ…
const patchPackMap = new Map();
let vNodeUid = 0;

// å¯¹æ¯”æ–°è€è™šæ‹ŸèŠ‚ç‚¹
export function diff(oldVNode, newVNode) {
  let index = 0;
  vNodeWalk(oldVNode, newVNode, index);
  return patchPackMap;
}

// æ·±åº¦éå†å¯¹æ¯”
function vNodeWalk(oldVNode, newVNode, index) {
  const patchSet = new Set();
  if (!newVNode) {
    // 1. å¦‚æœæ–°èŠ‚ç‚¹ä¸å­˜åœ¨, å°±æ·»åŠ ä¸€ä¸ªç§»é™¤èŠ‚ç‚¹çš„è¡¥ä¸åŒ…
    patchSet.add(new PatchPack(REMOVE, index));
  } else if (typeof newVNode === "string" && typeof oldVNode === "string") {
    // 2. å¦‚æœæ–°èŠ‚ç‚¹å’Œè€èŠ‚ç‚¹éƒ½æ˜¯æ–‡æœ¬,
    // å¹¶ä¸”æ–‡æœ¬å†…å®¹ä¸ç›¸ç­‰, å°±ç›´æ¥ä¿®æ”¹è€çš„èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹
    if (newVNode !== oldVNode) {
      patchSet.add(new PatchPack(TEXT, newVNode));
    }
  } else if (oldVNode.type === newVNode.type) {
    // 3. å¦‚æœæ–°è€èŠ‚ç‚¹æ ‡ç­¾åç›¸ç­‰, å¯¹æ¯”æ–°è€èŠ‚ç‚¹æ‰€æœ‰çš„å±æ€§å·®å¼‚
    // è·å–æ–°è€èŠ‚ç‚¹æ‰€æœ‰çš„å±æ€§è¡¥ä¸åŒ…
    const attrPatches = attrsWalk(oldVNode.props, newVNode.props);
    if (Object.keys(attrPatches).length > 0) {
      patchSet.add(new PatchPack(ATTR, attrPatches));
    }

    // å¯¹æ¯”å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹
    childrenWalk(oldVNode.children, newVNode.children);
  } else {
    // 4. å¦‚æœä¸Šé¢çš„3ç§æƒ…å†µ,é‚£ä¹ˆèŠ‚ç‚¹ä¸€å®šå‘ç”Ÿäº†å˜åŒ–,
    // é‚£ä¹ˆå°±éœ€è¦æ›¿æ¢åŸæ¥çš„èŠ‚ç‚¹, æ·»åŠ ä¸€ä¸ªæ›¿æ¢è¡¥ä¸åŒ…
    patchSet.add(new PatchPack(REPLACE, newVNode));
  }

  patchSet.size > 0 && patchPackMap.set(index, patchSet);
}

// å¯¹æ¯”æ–°è€èŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§, è·å–å±æ€§è¡¥ä¸åŒ…
function attrsWalk(oldProps, newProps) {
  const attrPatch = {};

  // èŠ‚ç‚¹å±æ€§ä¿®æ”¹çš„å¤„ç†: æ–°è€èŠ‚ç‚¹çš„å±æ€§ä¸ä¸€è‡´
  Object.keys(oldProps).forEach((key) => {
    if (oldProps[key] !== newProps[key]) {
      attrPatch[key] = newProps[key];
    }
  });

  // èŠ‚ç‚¹å±æ€§æ·»åŠ çš„å¤„ç†: æ–°è€èŠ‚ç‚¹å±æ€§ä¸ªæ•°ä¸ä¸€è‡´
  Object.keys(newProps).forEach((key) => {
    if (!oldProps.hasOwnProperty(key)) {
      attrPatch[key] = newProps[key];
    }
  });

  return attrPatch;
}

// å¯¹æ¯”å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹
// TODO: å¦‚æœæ–°èŠ‚ç‚¹æ¯”è€èŠ‚ç‚¹lengthè¦é•¿,
// é‚£ä¹ˆå¦‚æœæœ‰æ–°å¢åŠ çš„èŠ‚ç‚¹å°±éå†ä¸åˆ°
function childrenWalk(oldChildren, newChildren) {
  oldChildren.forEach((child, i) => {
    vNodeWalk(child, newChildren[i], ++vNodeUid);
  });
}
```

```js
// js/patch.js
"use strict";

import { VNode, setAttrs } from "./vnode";

/**
 * è¡¥ä¸åŒ…
 */
export class PatchPack {
  static ATTR    = "ATTR";
  static TEXT    = "TEXT";
  static REPLACE = "REPLACE";
  static REMOVE  = "REMOVE";

  constructor(type, value) {
    if (!PatchPack[type]) {
      throw new TypeError("[PatchPack] unknown PatchPack type");
    }
    this.type = type;
    this.value = value;
  }
}

let finalPatchMap = null;
let rNodeUid = 0;
/**
 * ç»™çœŸå®èŠ‚ç‚¹æ‰“è¡¥ä¸åŒ…
 * @param {HTMLElement} rDom çœŸå®çš„DOMå…ƒç´ 
 * @param {Map} patchMap è¡¥ä¸åŒ…
 */
export function patch(rDom, patchMap) {
  finalPatchMap = patchMap;
  rNodeWalk(rDom);
}

/**
 * é€’å½’éå†æ‰€æœ‰çš„çœŸå®èŠ‚ç‚¹(æ·±åº¦ä¼˜å…ˆ), æ›´æ–°è¡¥ä¸åŒ…è®°å½•çš„å†…å®¹
 * @param {HTMLElement} rNode çœŸå®çš„DOMå…ƒç´ 
 */
function rNodeWalk(rNode) {
  const rNodePatch = finalPatchMap.get(rNodeUid++); // Set
  const childNodes = Array.from(rNode.childNodes);

  // å¦‚æœæœ‰å­èŠ‚ç‚¹: é€’å½’çš„ç»™å­èŠ‚ç‚¹æ‰“è¡¥ä¸
  if (childNodes.length > 0) {
    childNodes.forEach((child) => {
      rNodeWalk(child);
    });
  }

  // å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰è¡¥ä¸åŒ… patch éœ€è¦æ›´æ–°
  rNodePatch && patchAction(rNode, rNodePatch);
}

/**
 * æ›´æ–°è¡¥ä¸åŒ…è®°å½•çš„å†…å®¹åˆ°çœŸå®çš„dom,è®©UIæ›´æ–°
 * @param {HTMLElement} rNode çœŸå®çš„DOMå…ƒç´ 
 * @param {PatchPack} patches è¡¥ä¸åŒ…
 */
function patchAction(rNode, patches) {
  for (const { type, value } of patches) {
    switch (type) {
      case PatchPack.ATTR:
        Object.keys(value).forEach((key) => {
          setAttrs(rNode, key, value[key]);
        });
        break;
      case PatchPack.TEXT:
        rNode.textContent = value;
        break;
      case PatchPack.REPLACE:
        // æ–°çš„èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹è¿˜æ˜¯å…ƒç´ èŠ‚ç‚¹
        const newRNode = rNode instanceof VNode
              ? document.createElement(value.type)
              : document.createTextNode(value);
        rNode.parentNode.replaceChild(newRNode, rNode);
        break;
      case PatchPack.REMOVE:
        rNode.remove();
        break;
      default:
        console.error("[patch] unknown PatchPack type");
        break;
    }
  }
}
```


